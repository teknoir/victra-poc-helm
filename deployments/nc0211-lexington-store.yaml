---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: nc0211-lexington-store
  namespace: default
spec:
  repo: https://teknoir.github.io/victra-poc-helm
  chart: victra-poc
  version: 0.0.6
  targetNamespace: default
  valuesContent: |-
    nvr:
      defaults:
        debugLevel: DEBUG
        motion:
          # Number of frames to skip inference when no motion detected
          inactiveInterval: 900
          # Number of frames to skip inference when motion is detected
          activeInterval: 3
        mqtt:
          # Send events without inference calculated
          nonInferenceEvents: false 
        image:
          # AMD64
          tag: ds7-gst1.24.7
        camera:
          # Special configuration for 360 cameras, contain data substream, need SPS/PPS headers are injected and it needed byte-stream with au alignment
          # Also configure the camera to use the dewarper to get the correct views
          pipeline:
            rtspsrc location={{.uri}} protocols=tcp latency=500 name=unmappedsrc
  
            unmappedsrc. ! application/x-rtp,media=video,encoding-name=H264 ! rtpjitterbuffer ! rtph264depay ! h264parse config-interval=-1 ! video/x-h264,stream-format=byte-stream,alignment=au ! nvv4l2decoder name=src
  
            src.
              ! queue ! nvvideoconvert ! video/x-raw(memory:NVMM),width=4000,height=3000
              ! queue ! nvdewarper config-file=/app/nvdewarper_config/config_nvdewarper.txt
              ! queue ! nvmux.sink_0 nvstreammux name=nvmux batch-size=4 width=1920 height=1080 num-surfaces-per-frame=1
              ! queue ! nvinferserver name=nvis config-file-path=/models/rtdetr_config.pbtxt unique-id=2 interval=5 
              ! queue ! nvinferserver config-file-path=/models/up_down_classifier_config.pbtxt unique-id=5
              ! queue ! nvinferserver config-file-path=/models/resnet50_pose_estimation_config.pbtxt unique-id=200
              ! queue ! nvtracker tracker-width=640 tracker-height=384 ll-lib-file=/opt/nvidia/deepstream/deepstream/lib/libnvds_nvmultiobjecttracker.so ll-config-file=/models/config_tracker_NvDeepSORT.yml compute-hw=2 gpu-id=0 
              ! queue ! nvstreamdemux name=nvdemux 
  
            nvdemux.src_0 
              ! queue ! tee name=tee
  
            tee.
              ! queue ! nvvideoconvert ! video/x-raw(memory:NVMM),width=[1,1920],height=[1,1080],pixel-aspect-ratio=1/1
              ! queue ! nvvideoconvert ! queue 
              ! queue ! nvjpegenc quality=55 ! appsink sync=0 name=mqttsink 
  
            tee.
              ! queue ! nvvideoconvert compute-hw=GPU ! video/x-raw,format=RGB,width=[1,640],height=[1,360],pixel-aspect-ratio=1/1 
              ! queue ! motioncells threshold=0.00005 gridx=32 gridy=18 ! fakesink 
  
            tee.
              ! queue ! nvvideoconvert ! video/x-raw(memory:NVMM),width=1920,height=1080 
              ! queue ! nvvideoconvert ! queue ! videorate ! video/x-raw,framerate=10/1 
              ! queue ! nvvideoconvert 
              ! queue ! nvv4l2h264enc copy-meta=true profile=7 control-rate=1 bitrate=3000000 iframeinterval=5 
              ! queue ! h264parse ! queue ! splitmuxsink muxer-properties=properties,streamable=true,moov-relocation=true send-keyframe-requests=true location=/app/videos/{{.camera_id}}_%05d.mp4 max-size-time=15000000000 max-files=2880 name=splitmux
  
      instances:
        - name: nc0211-front-door-1
          camera:
            uri: rtsp://admin:Redex1997!@192.168.51.117/stream1
            pipeline: |-
              uridecodebin3 uri={{.uri}} name=src 
  
              src.
                ! queue ! nvvideoconvert ! video/x-raw(memory:NVMM),width=2688,height=1520 ! queue 
                ! queue ! nvmux.sink_0 nvstreammux name=nvmux batch-size=4 width=2688 height=1520 
                ! queue ! nvinferserver name=nvis config-file-path=/models/rtdetr_config.pbtxt unique-id=2 interval=5 
                ! queue ! nvinferserver config-file-path=/models/up_down_classifier_config.pbtxt unique-id=5
                ! queue ! nvinferserver config-file-path=/models/resnet50_pose_estimation_config.pbtxt unique-id=200
                ! queue ! nvtracker tracker-width=640 tracker-height=384 ll-lib-file=/opt/nvidia/deepstream/deepstream/lib/libnvds_nvmultiobjecttracker.so ll-config-file=/models/config_tracker_NvDeepSORT.yml compute-hw=2 gpu-id=0 
                ! queue ! nvstreamdemux name=nvdemux 
  
              nvdemux.src_0 
                ! queue ! tee name=tee
  
              tee.
                ! queue ! nvdsanalytics config-file=/app/nvdsanalytics_config/config_nvdsanalytics.txt 
                ! queue ! nvdsosd display-bbox=0 display-text=0
                ! queue ! nvvideoconvert ! video/x-raw(memory:NVMM),width=[1,1920],height=[1,1080],pixel-aspect-ratio=1/1
                ! queue ! nvvideoconvert ! queue 
                ! queue ! nvjpegenc quality=75 ! appsink sync=0 name=mqttsink 
  
              tee.
                ! queue ! nvvideoconvert compute-hw=GPU ! video/x-raw,format=RGB,width=[1,640],height=[1,360],pixel-aspect-ratio=1/1 
                ! queue ! motioncells threshold=0.00005 gridx=32 gridy=18 ! fakesink 
  
              tee.
                ! queue ! nvvideoconvert ! video/x-raw(memory:NVMM),width=1920,height=1080 
                ! queue ! nvvideoconvert ! queue ! videorate ! video/x-raw,framerate=10/1 
                ! queue ! nvvideoconvert 
                ! queue ! nvv4l2h264enc copy-meta=true profile=7 control-rate=1 bitrate=3000000 iframeinterval=5 
                ! queue ! h264parse ! queue ! splitmuxsink muxer-properties=properties,streamable=true,moov-relocation=true send-keyframe-requests=true location=/app/videos/{{.camera_id}}_%05d.mp4 max-size-time=15000000000 max-files=2880 name=splitmux

          nvdsanalytics:
            enabled: true
            config: |
              [property]
              enable=1
              config-width=1920
              config-height=1080
              osd-mode=0
              display-font-size=25

              [line-crossing-stream-0]
              enable=1
              extended=0
              line-crossing-Entry-0=893;513;872;712;746;698;997;726
              line-crossing-Exit-0=850;911;872;712;997;726;746;698

        - name: nc0211-pos
          camera:
            uri: rtsp://admin:Redex1997!@192.168.51.113/stream1
            pipeline: |-
              uridecodebin3 uri={{.uri}} name=src 
  
              src.
                ! queue ! nvvideoconvert ! video/x-raw(memory:NVMM),width=2688,height=1520 ! queue 
                ! queue ! nvmux.sink_0 nvstreammux name=nvmux batch-size=4 width=2688 height=1520 
                ! queue ! nvinferserver name=nvis config-file-path=/models/rtdetr_config.pbtxt unique-id=2 interval=5 
                ! queue ! nvinferserver config-file-path=/models/up_down_classifier_config.pbtxt unique-id=5
                ! queue ! nvinferserver config-file-path=/models/resnet50_pose_estimation_config.pbtxt unique-id=200
                ! queue ! nvtracker tracker-width=640 tracker-height=384 ll-lib-file=/opt/nvidia/deepstream/deepstream/lib/libnvds_nvmultiobjecttracker.so ll-config-file=/models/config_tracker_NvDeepSORT.yml compute-hw=2 gpu-id=0 
                ! queue ! nvstreamdemux name=nvdemux 
  
              nvdemux.src_0 
                ! queue ! tee name=tee
  
              tee.
                ! queue ! nvvideoconvert ! video/x-raw(memory:NVMM),width=[1,1920],height=[1,1080],pixel-aspect-ratio=1/1
                ! queue ! nvvideoconvert ! queue 
                ! queue ! nvjpegenc quality=75 ! appsink sync=0 name=mqttsink 
  
              tee.
                ! queue ! nvvideoconvert compute-hw=GPU ! video/x-raw,format=RGB,width=[1,640],height=[1,360],pixel-aspect-ratio=1/1 
                ! queue ! motioncells threshold=0.00005 gridx=32 gridy=18 ! fakesink 
  
              tee.
                ! queue ! nvvideoconvert ! video/x-raw(memory:NVMM),width=1920,height=1080 
                ! queue ! nvvideoconvert ! queue ! videorate ! video/x-raw,framerate=10/1 
                ! queue ! nvvideoconvert 
                ! queue ! nvv4l2h264enc copy-meta=true profile=7 control-rate=1 bitrate=3000000 iframeinterval=5 
                ! queue ! h264parse ! queue ! splitmuxsink muxer-properties=properties,streamable=true,moov-relocation=true send-keyframe-requests=true location=/app/videos/{{.camera_id}}_%05d.mp4 max-size-time=15000000000 max-files=2880 name=splitmux
    
        - name: nc0211-backroom-safe-door-0
          camera:
            uri: rtsp://admin:Redex1997!@192.168.51.115/stream1
          nvdewarper:
            enabled: true
            config: |
              [property]
              enable=1
              source-id=0
              output-width=1920
              output-height=1080
              num-batch-buffers=1
    
              [surface0]
              surface-index=0
              projection-type=4
              width=2560
              height=1440
              rot-axes=ZXY
              pitch=30
              yaw=0
              roll=0
              src-fov=180
              src-x0=2000
              src-y0=1500
              focal-length=960
              distortion=0;0;0;0
    
        - name: nc0211-backroom-safe-door-90
          camera:
            uri: rtsp://admin:Redex1997!@192.168.51.115/stream1
          nvdewarper:
            enabled: true
            config: |
              [property]
              enable=1
              source-id=0
              output-width=1920
              output-height=1080
              num-batch-buffers=1
    
              [surface0]
              surface-index=0
              projection-type=4
              width=2560
              height=1440
              rot-axes=ZXY
              pitch=30
              yaw=0
              roll=90
              src-fov=180
              src-x0=2000
              src-y0=1500
              focal-length=960
              distortion=0;0;0;0

        - name: nc0211-backroom-safe-door-180
          camera:
            uri: rtsp://admin:Redex1997!@192.168.51.115/stream1
          nvdewarper:
            enabled: true
            config: |
              [property]
              enable=1
              source-id=0
              output-width=1920
              output-height=1080
              num-batch-buffers=1
    
              [surface0]
              surface-index=0
              projection-type=4
              width=2560
              height=1440
              rot-axes=ZXY
              pitch=50
              yaw=0
              roll=180
              src-fov=180
              src-x0=2000
              src-y0=1500
              focal-length=960
              distortion=0;0;0;0
    
        - name: nc0211-backroom-safe-door-270
          camera:
            uri: rtsp://admin:Redex1997!@192.168.51.115/stream1
          nvdewarper:
            enabled: true
            config: |
              [property]
              enable=1
              source-id=0
              output-width=1920
              output-height=1080
              num-batch-buffers=1
    
              [surface0]
              surface-index=0
              projection-type=4
              width=2560
              height=1440
              rot-axes=ZXY
              pitch=50
              yaw=0
              roll=270
              src-fov=180
              src-x0=2000
              src-y0=1500
              focal-length=960
              distortion=0;0;0;0
    
        - name: nc0211-safe-back-door-0
          camera:
            uri: rtsp://admin:Redex1997!@192.168.51.114/stream1
          nvdewarper:
            enabled: true
            config: |
              [property]
              enable=1
              source-id=0
              output-width=1920
              output-height=1080
              num-batch-buffers=1
    
              [surface0]
              surface-index=0
              projection-type=4
              width=2560
              height=1440
              rot-axes=ZXY
              pitch=50
              yaw=0
              roll=0
              src-fov=180
              src-x0=2000
              src-y0=1500
              focal-length=960
              distortion=0;0;0;0
    
        - name: nc0211-safe-back-door-90
          camera:
            uri: rtsp://admin:Redex1997!@192.168.51.114/stream1
          nvdewarper:
            enabled: true
            config: |
              [property]
              enable=1
              source-id=0
              output-width=1920
              output-height=1080
              num-batch-buffers=1
    
              [surface0]
              surface-index=0
              projection-type=4
              width=2560
              height=1440
              rot-axes=ZXY
              pitch=30
              yaw=0
              roll=90
              src-fov=180
              src-x0=2000
              src-y0=1500
              focal-length=960
              distortion=0;0;0;0
    
        - name: nc0211-safe-back-door-180
          camera:
            uri: rtsp://admin:Redex1997!@192.168.51.114/stream1
          nvdewarper:
            enabled: true
            config: |
              [property]
              enable=1
              source-id=0
              output-width=1920
              output-height=1080
              num-batch-buffers=1
    
              [surface0]
              surface-index=0
              projection-type=4
              width=2560
              height=1440
              rot-axes=ZXY
              pitch=30
              yaw=0
              roll=180
              src-fov=180
              src-x0=2000
              src-y0=1500
              focal-length=960
              distortion=0;0;0;0
    
        - name: nc0211-safe-back-door-270
          camera:
            uri: rtsp://admin:Redex1997!@192.168.51.114/stream1
          nvdewarper:
            enabled: true
            config: |
              [property]
              enable=1
              source-id=0
              output-width=1920
              output-height=1080
              num-batch-buffers=1
    
              [surface0]
              surface-index=0
              projection-type=4
              width=2560
              height=1440
              rot-axes=ZXY
              pitch=50
              yaw=0
              roll=270
              src-fov=180
              src-x0=2000
              src-y0=1500
              focal-length=960
              distortion=0;0;0;0  

        - name: nc0211-sales-floor-0
          camera:
            uri: rtsp://admin:Redex1997!@192.168.51.111/stream1
          nvdewarper:
            enabled: true
            config: |
              [property]
              enable=1
              source-id=0
              output-width=1920
              output-height=1080
              num-batch-buffers=1
    
              [surface0]
              surface-index=0
              projection-type=4
              width=2560
              height=1440
              rot-axes=ZXY
              pitch=50
              yaw=0
              roll=0
              src-fov=180
              src-x0=2000
              src-y0=1500
              focal-length=960
              distortion=0;0;0;0

        - name: nc0211-sales-floor-90
          camera:
            uri: rtsp://admin:Redex1997!@192.168.51.111/stream1
          nvdewarper:
            enabled: true
            config: |
              [property]
              enable=1
              source-id=0
              output-width=1920
              output-height=1080
              num-batch-buffers=1
    
              [surface0]
              surface-index=0
              projection-type=4
              width=2560
              height=1440
              rot-axes=ZXY
              pitch=50
              yaw=0
              roll=90
              src-fov=180
              src-x0=2000
              src-y0=1500
              focal-length=960
              distortion=0;0;0;0
    
        - name: nc0211-sales-floor-180
          camera:
            uri: rtsp://admin:Redex1997!@192.168.51.111/stream1
          nvdewarper:
            enabled: true
            config: |
              [property]
              enable=1
              source-id=0
              output-width=1920
              output-height=1080
              num-batch-buffers=1
    
              [surface0]
              surface-index=0
              projection-type=4
              width=2560
              height=1440
              rot-axes=ZXY
              pitch=50
              yaw=0
              roll=180
              src-fov=180
              src-x0=2000
              src-y0=1500
              focal-length=960
              distortion=0;0;0;0

        - name: nc0211-sales-floor-270
          camera:
            uri: rtsp://admin:Redex1997!@192.168.51.111/stream1
          nvdewarper:
            enabled: true
            config: |
              [property]
              enable=1
              source-id=0
              output-width=1920
              output-height=1080
              num-batch-buffers=1
    
              [surface0]
              surface-index=0
              projection-type=4
              width=2560
              height=1440
              rot-axes=ZXY
              pitch=50
              yaw=0
              roll=270
              src-fov=180
              src-x0=2000
              src-y0=1500
              focal-length=960
              distortion=0;0;0;0

        - name: nc0211-height-strip
          camera:
            uri: rtsp://admin:Redex1997!@192.168.51.112/live.sdp
            pipeline: |-
              rtspsrc location={{.uri}} protocols=tcp latency=500 name=unmappedsrc
      
              unmappedsrc. ! application/x-rtp,media=video,encoding-name=H264 ! rtpjitterbuffer ! rtph264depay ! h264parse config-interval=-1 ! video/x-h264,stream-format=byte-stream,alignment=au ! nvv4l2decoder name=src
  
              src.
                ! queue ! nvvideoconvert ! video/x-raw(memory:NVMM),width=1920,height=1080 ! queue 
                ! queue ! nvmux.sink_0 nvstreammux name=nvmux batch-size=4 width=1920 height=1080 
                ! queue ! nvinferserver name=nvis config-file-path=/models/rtdetr_config.pbtxt unique-id=2 interval=5 
                ! queue ! nvinferserver config-file-path=/models/up_down_classifier_config.pbtxt unique-id=5
                ! queue ! nvinferserver config-file-path=/models/resnet50_pose_estimation_config.pbtxt unique-id=200
                ! queue ! nvtracker tracker-width=640 tracker-height=384 ll-lib-file=/opt/nvidia/deepstream/deepstream/lib/libnvds_nvmultiobjecttracker.so ll-config-file=/models/config_tracker_NvDeepSORT.yml compute-hw=2 gpu-id=0 
                ! queue ! nvstreamdemux name=nvdemux 
  
              nvdemux.src_0 
                ! queue ! tee name=tee
  
              tee.
                ! queue ! nvvideoconvert ! video/x-raw(memory:NVMM),width=[1,1920],height=[1,1080],pixel-aspect-ratio=1/1
                ! queue ! nvvideoconvert ! queue 
                ! queue ! nvjpegenc quality=75 ! appsink sync=0 name=mqttsink 
  
              tee.
                ! queue ! nvvideoconvert compute-hw=GPU ! video/x-raw,format=RGB,width=[1,640],height=[1,360],pixel-aspect-ratio=1/1 
                ! queue ! motioncells threshold=0.00005 gridx=32 gridy=18 ! fakesink 
  
              tee.
                ! queue ! nvvideoconvert ! video/x-raw(memory:NVMM),width=1920,height=1080 
                ! queue ! nvvideoconvert ! queue ! videorate ! video/x-raw,framerate=10/1 
                ! queue ! nvvideoconvert 
                ! queue ! nvv4l2h264enc copy-meta=true profile=7 control-rate=1 bitrate=3000000 iframeinterval=5 
                ! queue ! h264parse ! queue ! splitmuxsink muxer-properties=properties,streamable=true,moov-relocation=true send-keyframe-requests=true location=/app/videos/{{.camera_id}}_%05d.mp4 max-size-time=15000000000 max-files=2880 name=splitmux
  
        - name: nc0211-front-door-2
          camera:
            uri: rtsp://admin:Redex1997!@192.168.51.116/live.sdp
            pipeline: |-
              uridecodebin3 uri={{.uri}} name=src 
  
              src.
                ! queue ! nvvideoconvert ! video/x-raw(memory:NVMM),width=2688,height=1520 ! queue 
                ! queue ! nvmux.sink_0 nvstreammux name=nvmux batch-size=4 width=2688 height=1520 
                ! queue ! nvinferserver name=nvis config-file-path=/models/rtdetr_config.pbtxt unique-id=2 interval=5 
                ! queue ! nvinferserver config-file-path=/models/up_down_classifier_config.pbtxt unique-id=5
                ! queue ! nvinferserver config-file-path=/models/resnet50_pose_estimation_config.pbtxt unique-id=200
                ! queue ! nvtracker tracker-width=640 tracker-height=384 ll-lib-file=/opt/nvidia/deepstream/deepstream/lib/libnvds_nvmultiobjecttracker.so ll-config-file=/models/config_tracker_NvDeepSORT.yml compute-hw=2 gpu-id=0 
                ! queue ! nvstreamdemux name=nvdemux 
  
              nvdemux.src_0 
                ! queue ! tee name=tee
  
              tee.
                ! queue ! nvdsanalytics config-file=/app/nvdsanalytics_config/config_nvdsanalytics.txt
                ! queue ! nvdsosd display-bbox=0 display-text=0
                ! queue ! nvvideoconvert ! video/x-raw(memory:NVMM),width=[1,1920],height=[1,1080],pixel-aspect-ratio=1/1
                ! queue ! nvvideoconvert ! queue 
                ! queue ! nvjpegenc quality=75 ! appsink sync=0 name=mqttsink 
  
              tee.
                ! queue ! nvvideoconvert compute-hw=GPU ! video/x-raw,format=RGB,width=[1,640],height=[1,360],pixel-aspect-ratio=1/1 
                ! queue ! motioncells threshold=0.00005 gridx=32 gridy=18 ! fakesink 
  
              tee.
                ! queue ! nvvideoconvert ! video/x-raw(memory:NVMM),width=1920,height=1080 
                ! queue ! nvvideoconvert ! queue ! videorate ! video/x-raw,framerate=10/1 
                ! queue ! nvvideoconvert 
                ! queue ! nvv4l2h264enc copy-meta=true profile=7 control-rate=1 bitrate=3000000 iframeinterval=5 
                ! queue ! h264parse ! queue ! splitmuxsink muxer-properties=properties,streamable=true,moov-relocation=true send-keyframe-requests=true location=/app/videos/{{.camera_id}}_%05d.mp4 max-size-time=15000000000 max-files=2880 name=splitmux

          nvdsanalytics:
            enabled: true
            config: |
              [property]
              enable=1
              config-width=1920
              config-height=1080
              osd-mode=0
              display-font-size=25

              [line-crossing-stream-0]
              enable=1
              extended=0
              line-crossing-Entry-0=1001;472;1003;672;878;673;1127;671
              line-crossing-Exit-0=1004;872;1003;672;1127;671;878;673

    observatory-pipeline:
      defaults:
        debugLevel: DEBUG

      streams:
        - stream: update-frame-rate-control
        - stream: record-detections
        - stream: update-movements
        - stream: compreface
          mqtt:
            topicFaces: "toe/events/faces"
          facerec:
            compreFaceApiKey: "00000000-0000-0000-0000-000000000002"
            faceRecThreshold: 0.9
            faceImageSize: 100
        # ALERTS
        - stream: loitering
        - stream: person-down
        - stream: line-crossing
        - stream: hands-up
        - stream: running
        - stream: face-cover
        - stream: weapons
        # ALERT PROCESSING
        - stream: update-alerts
  
      clickhouse:
        resources:
          limits:
            cpu: 2000m
            memory: 12Gi
          requests:
            cpu: 10m
            memory: 50Mi
        nodePort:
          enabled: true
      keydb:
        nodePort:
          enabled: true
      
      file-transfer:
        defaults:
          debugLevel: DEBUG
  
          labels:
            deviceID: "victra-poc-03"
            namespace: "victra-poc"
            domain: "teknoir.cloud"
  
          resources:
            limits:
              cpu: 2000m
              memory: 5Gi
            requests:
              cpu: 10m
              memory: 50Mi
        streams:
          - stream: prepare-file
            video:
              mountSegmentPath: true
              mountClipTempPath: true
          - stream: transfer-file      
            video:
              mountSegmentPath: true
              mountClipTempPath: true
